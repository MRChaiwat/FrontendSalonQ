<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองคิวออนไลน์</title>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/2.22.3/liff.js"></script>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Prompt:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .form-input, .form-select {
            @apply block w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-200;
        }
        .btn-primary {
            @apply w-full py-4 px-4 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-300 ease-in-out;
        }
    </style>
</head>
<body>

    <div class="container bg-white rounded-xl shadow-2xl mt-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">จองคิวออนไลน์</h1>
        <p class="text-center text-gray-600 mb-8">กรุณากรอกรายละเอียดเพื่อทำการจองคิว</p>
        
        <form id="bookingForm" class="space-y-6">
            
            <!-- Date and Time -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="w-full sm:w-1/2">
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
                    <input type="date" id="date" class="form-input" required>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="time" class="block text-sm font-medium text-gray-700 mb-1">เวลา</label>
                    <input type="time" id="time" class="form-input" required>
                </div>
            </div>

            <!-- Main Service and Sub Service -->
            <div>
                <label for="mainService" class="block text-sm font-medium text-gray-700 mb-1">บริการหลัก</label>
                <select id="mainService" class="form-select" required>
                    <option value="" disabled selected>เลือกบริการหลัก</option>
                </select>
            </div>
            <div>
                <label for="subService" class="block text-sm font-medium text-gray-700 mb-1">บริการย่อย</label>
                <select id="subService" class="form-select" required>
                    <option value="" disabled selected>เลือกบริการย่อย</option>
                </select>
            </div>

            <!-- Technician -->
            <div>
                <label for="technician" class="block text-sm font-medium text-gray-700 mb-1">เลือกช่าง</label>
                <select id="technician" class="form-select" required>
                    <option value="" disabled selected>เลือกช่าง</option>
                </select>
            </div>

            <!-- Price (hidden input for now) -->
            <input type="hidden" id="price" value="0">

            <!-- Customer Info -->
            <div>
                <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อลูกค้า</label>
                <input type="text" id="customerName" class="form-input" readonly>
            </div>
            <div>
                <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label>
                <input type="tel" id="phoneNumber" class="form-input" placeholder="0812345678" required>
            </div>
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                <textarea id="notes" class="form-input h-24" placeholder="ข้อความถึงช่าง..."></textarea>
            </div>
            
            <input type="hidden" id="lineUserId">

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="btn-primary" disabled>
                กำลังโหลด...
            </button>
        </form>

        <div id="statusMessage" class="text-center mt-4 text-sm font-medium"></div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // *** IMPORTANT ***
        // แทนที่ URL ด้านล่างด้วย URL จริงของ Backend Server ที่คุณ Deploy บน Render
        const backendUrl = 'https://salon-rbms.onrender.com/api/booking';
        
        // ข้อมูลบริการและช่าง (สามารถดึงมาจาก Backend แทนได้ในอนาคต)
        const services = {
            'ตัด': ['ตัดผมชาย', 'ตัดผมหญิง'],
            'ยืด': ['ยืดวอลลุ่ม', 'ยืดถาวร'],
            'ดัด': ['ดัดดิจิตอล', 'ดัดสปาเพิร์ม'],
            'ทำสี': ['ทำสีแฟชั่น', 'ทำสีปิดผมขาว']
        };
        const technicians = ['ช่างทดสอบ', 'ช่างเอ', 'ช่างบี'];

        // --- 2. DOM ELEMENTS ---
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const mainServiceSelect = document.getElementById('mainService');
        const subServiceSelect = document.getElementById('subService');
        const technicianSelect = document.getElementById('technician');
        const customerNameInput = document.getElementById('customerName');
        const lineUserIdInput = document.getElementById('lineUserId');
        const bookingForm = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');

        let userProfile = null;

        // --- 3. UI SETUP FUNCTIONS ---

        // Function เพื่อเติมตัวเลือกบริการ
        function populateServiceOptions() {
            for (const service in services) {
                const option = document.createElement('option');
                option.value = service;
                option.textContent = service;
                mainServiceSelect.appendChild(option);
            }
        }
        
        // Function เพื่อเติมตัวเลือกบริการย่อยตามบริการหลักที่เลือก
        function populateSubServiceOptions(selectedService) {
            subServiceSelect.innerHTML = '<option value="" disabled selected>เลือกบริการย่อย</option>';
            if (selectedService && services[selectedService]) {
                services[selectedService].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subServiceSelect.appendChild(option);
                });
            }
        }

        // Function เพื่อเติมตัวเลือกช่าง
        function populateTechnicianOptions() {
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                technicianSelect.appendChild(option);
            });
        }

        // Function เพื่อตั้งค่าวันที่เริ่มต้น
        function setMinDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.min = `${year}-${month}-${day}`;
        }
        
        // --- 4. LIFF INITIALIZATION ---
        async function initializeLiff() {
            try {
                // Initialize LIFF
                await liff.init({ liffId: '2007895406-VWgOqgvW' }); // *** อย่าลืมแทนที่ด้วย LIFF ID ของคุณ ***
                
                if (liff.isLoggedIn()) {
                    // Get user profile if logged in
                    userProfile = await liff.getProfile();
                    customerNameInput.value = userProfile.displayName;
                    lineUserIdInput.value = userProfile.userId;
                    
                    submitBtn.textContent = 'ยืนยันการจอง';
                    submitBtn.disabled = false;
                } else {
                    // If not logged in, redirect to login page
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed', error);
                statusMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อกับ LINE LIFF';
            }
        }
        
        // --- 5. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setMinDate();
            populateServiceOptions();
            populateTechnicianOptions();
            initializeLiff();
        });

        mainServiceSelect.addEventListener('change', (event) => {
            populateSubServiceOptions(event.target.value);
        });

        bookingForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // ป้องกันการ reload หน้าเว็บ
            
            submitBtn.textContent = 'กำลังส่งข้อมูล...';
            submitBtn.disabled = true;
            statusMessage.textContent = 'โปรดรอสักครู่...';
            
            // Collect form data
            const bookingData = {
                timestamp: new Date().toISOString(),
                date: dateInput.value,
                time: timeInput.value,
                mainService: mainServiceSelect.value,
                subService: subServiceSelect.value,
                technician: technicianSelect.value,
                price: parseInt(document.getElementById('price').value, 10),
                customerName: customerNameInput.value,
                lineUserId: lineUserIdInput.value,
                phoneNumber: document.getElementById('phoneNumber').value,
                notes: document.getElementById('notes').value,
            };
            
            console.log('Sending booking data:', bookingData);

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData),
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusMessage.textContent = '✅ จองคิวสำเร็จแล้ว! ระบบจะแจ้งเตือนใน LINE ครับ';
                    statusMessage.classList.add('text-green-600');
                    // ปิดหน้า LIFF หลังจากจองสำเร็จ
                    liff.closeWindow();
                } else {
                    statusMessage.textContent = `❌ เกิดข้อผิดพลาด: ${result.message}`;
                    statusMessage.classList.add('text-red-600');
                }
            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = '❌ เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์';
                statusMessage.classList.add('text-red-600');
            } finally {
                submitBtn.textContent = 'ยืนยันการจอง';
                submitBtn.disabled = false;
            }
        });
        
    </script>
</body>
</html>
