<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองคิวออนไลน์</title>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/2.22.3/liff.js"></script>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Prompt:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .form-input, .form-select {
            @apply block w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-200;
        }
        .btn-primary {
            @apply w-full py-4 px-4 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-300 ease-in-out;
        }
        .time-slot {
            @apply px-4 py-2 border rounded-lg text-center cursor-pointer transition-colors duration-200;
        }
        .time-slot.available {
            @apply bg-white border-green-400 text-green-700 hover:bg-green-50;
        }
        .time-slot.booked {
            @apply bg-gray-200 border-gray-300 text-gray-500 cursor-not-allowed;
        }
        .time-slot.selected {
            @apply bg-green-500 text-white shadow-lg;
        }
    </style>
</head>
<body>

    <div class="container bg-white rounded-xl shadow-2xl mt-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">จองคิวออนไลน์</h1>
        <p class="text-center text-gray-600 mb-8">กรุณากรอกรายละเอียดเพื่อทำการจองคิว</p>
        
        <form id="bookingForm" class="space-y-6">
            
            <!-- Date -->
            <div>
                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
                <input type="date" id="date" class="form-input" required>
            </div>
            
            <!-- Time Slots -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เวลา</label>
                <div id="timeSlots" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                    <!-- Time slots will be generated here by JavaScript -->
                </div>
                <div id="timeStatusMessage" class="text-center mt-2 text-sm font-medium text-red-500 hidden"></div>
            </div>

            <!-- Main Service and Sub Service -->
            <div>
                <label for="mainService" class="block text-sm font-medium text-gray-700 mb-1">บริการหลัก</label>
                <select id="mainService" class="form-select" required>
                    <option value="" disabled selected>เลือกบริการหลัก</option>
                </select>
            </div>
            <div>
                <label for="subService" class="block text-sm font-medium text-gray-700 mb-1">บริการย่อย</label>
                <select id="subService" class="form-select" required>
                    <option value="" disabled selected>เลือกบริการย่อย</option>
                </select>
            </div>

            <!-- Technician -->
            <div>
                <label for="technician" class="block text-sm font-medium text-gray-700 mb-1">เลือกช่าง</label>
                <select id="technician" class="form-select" required>
                    <option value="" disabled selected>เลือกช่าง</option>
                </select>
            </div>

            <!-- Price (hidden input for now) -->
            <input type="hidden" id="price" value="0">

            <!-- Customer Info -->
            <div>
                <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อลูกค้า</label>
                <input type="text" id="customerName" class="form-input" readonly>
            </div>
            <div>
                <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label>
                <input type="tel" id="phoneNumber" class="form-input" placeholder="0812345678" required>
            </div>
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                <textarea id="notes" class="form-input h-24" placeholder="ข้อความถึงช่าง..."></textarea>
            </div>
            
            <input type="hidden" id="lineUserId">

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="btn-primary" disabled>
                กำลังโหลด...
            </button>
        </form>

        <div id="statusMessage" class="text-center mt-4 text-sm font-medium"></div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // *** IMPORTANT ***
        // แทนที่ URL ด้านล่างด้วย URL จริงของ Backend Server ที่คุณ Deploy บน Render
        const backendUrl = 'https://salon-rbms.onrender.com//api/booking';
        const availabilityUrl = 'https://salon-rbms.onrender.com//api/availability';
        
        // ข้อมูลบริการและช่าง (สามารถดึงมาจาก Backend แทนได้ในอนาคต)
        const services = {
            'ตัด': ['ตัดผมชาย', 'ตัดผมหญิง'],
            'ยืด': ['ยืดวอลลุ่ม', 'ยืดถาวร'],
            'ดัด': ['ดัดดิจิตอล', 'ดัดสปาเพิร์ม'],
            'ทำสี': ['ทำสีแฟชั่น', 'ทำสีปิดผมขาว']
        };
        const technicians = ['ช่างทดสอบ', 'ช่างเอ', 'ช่างบี'];
        
        // ช่วงเวลาทำการของร้าน
        const openHours = {
            start: 9, // 9:00
            end: 18,  // 18:00
            interval: 30 // 30 นาที
        };

        // --- 2. DOM ELEMENTS ---
        const dateInput = document.getElementById('date');
        const timeSlotsContainer = document.getElementById('timeSlots');
        const timeStatusMessage = document.getElementById('timeStatusMessage');
        const mainServiceSelect = document.getElementById('mainService');
        const subServiceSelect = document.getElementById('subService');
        const technicianSelect = document.getElementById('technician');
        const customerNameInput = document.getElementById('customerName');
        const lineUserIdInput = document.getElementById('lineUserId');
        const bookingForm = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');

        let userProfile = null;
        let selectedTime = null;

        // --- 3. UI SETUP FUNCTIONS ---

        // Function เพื่อเติมตัวเลือกบริการ
        function populateServiceOptions() {
            for (const service in services) {
                const option = document.createElement('option');
                option.value = service;
                option.textContent = service;
                mainServiceSelect.appendChild(option);
            }
        }
        
        // Function เพื่อเติมตัวเลือกบริการย่อยตามบริการหลักที่เลือก
        function populateSubServiceOptions(selectedService) {
            subServiceSelect.innerHTML = '<option value="" disabled selected>เลือกบริการย่อย</option>';
            if (selectedService && services[selectedService]) {
                services[selectedService].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subServiceSelect.appendChild(option);
                });
            }
        }

        // Function เพื่อเติมตัวเลือกช่าง
        function populateTechnicianOptions() {
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                technicianSelect.appendChild(option);
            });
        }

        // Function เพื่อตั้งค่าวันที่เริ่มต้น
        function setMinDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.min = `${year}-${month}-${day}`;
        }

        // Function เพื่อสร้างช่องเวลา
        function generateTimeSlots(bookedSlots = []) {
            timeSlotsContainer.innerHTML = ''; // เคลียร์ช่องเวลาเดิม
            selectedTime = null; // รีเซ็ตเวลาที่เลือก
            let hasAvailableSlots = false;
            
            const now = new Date();
            const selectedDate = new Date(dateInput.value);
            const isToday = selectedDate.toDateString() === now.toDateString();

            for (let hour = openHours.start; hour <= openHours.end; hour++) {
                for (let minute = 0; minute < 60; minute += openHours.interval) {
                    // ไม่สร้างช่องเวลาถ้าเกินเวลาปิด
                    if (hour === openHours.end && minute > 0) continue;

                    const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    const slotElement = document.createElement('div');
                    slotElement.textContent = time;
                    slotElement.classList.add('time-slot');

                    const isTimePast = isToday && (new Date(selectedDate.setHours(hour, minute)) < now);
                    const isBooked = bookedSlots.includes(time);

                    if (isBooked || isTimePast) {
                        slotElement.classList.add('booked');
                        slotElement.disabled = true;
                    } else {
                        slotElement.classList.add('available');
                        slotElement.addEventListener('click', () => {
                            // ลบคลาส 'selected' จากช่องเวลาอื่น
                            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                            // เพิ่มคลาส 'selected' ในช่องเวลาที่ถูกเลือก
                            slotElement.classList.add('selected');
                            selectedTime = time;
                            // อัปเดตสถานะปุ่มจอง
                            checkFormValidity();
                        });
                        hasAvailableSlots = true;
                    }

                    timeSlotsContainer.appendChild(slotElement);
                }
            }
            timeStatusMessage.textContent = hasAvailableSlots ? '' : 'ขออภัย วันนี้คิวเต็มแล้ว';
            timeStatusMessage.classList.toggle('hidden', hasAvailableSlots);
        }

        // Function เพื่อตรวจสอบความพร้อมของฟอร์ม
        function checkFormValidity() {
            const isValid = bookingForm.checkValidity() && selectedTime;
            submitBtn.disabled = !isValid;
        }

        // --- 4. LIFF INITIALIZATION & AVAILABILITY CHECK ---
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2007895406-VWgOqgvW' }); // *** อย่าลืมแทนที่ด้วย LIFF ID ของคุณ ***
                
                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                    customerNameInput.value = userProfile.displayName;
                    lineUserIdInput.value = userProfile.userId;
                    
                    submitBtn.textContent = 'ยืนยันการจอง';
                    submitBtn.disabled = false;
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed', error);
                statusMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อกับ LINE LIFF';
            }
        }
        
        async function fetchBookedSlots(date) {
            if (!date) {
                generateTimeSlots();
                return;
            }
            
            statusMessage.textContent = 'กำลังตรวจสอบคิวว่าง...';
            statusMessage.classList.remove('hidden');
            
            try {
                // Fetch booked slots for the selected date
                const response = await fetch(`${availabilityUrl}?date=${date}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const bookedSlots = await response.json();
                
                generateTimeSlots(bookedSlots);
                
                statusMessage.textContent = ''; // Clear status message
                statusMessage.classList.add('hidden');
            } catch (error) {
                console.error('Error fetching booked slots:', error);
                statusMessage.textContent = '❌ เกิดข้อผิดพลาดในการตรวจสอบคิวว่าง';
                statusMessage.classList.remove('hidden');
                generateTimeSlots(); // Show empty or default slots
            }
        }

        // --- 5. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setMinDate();
            populateServiceOptions();
            populateTechnicianOptions();
            initializeLiff();
            
            // Generate initial time slots on load
            generateTimeSlots();
        });

        dateInput.addEventListener('change', (event) => {
            fetchBookedSlots(event.target.value);
            checkFormValidity();
        });

        mainServiceSelect.addEventListener('change', (event) => {
            populateSubServiceOptions(event.target.value);
            checkFormValidity();
        });
        
        technicianSelect.addEventListener('change', () => {
            checkFormValidity();
        });

        bookingForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            
            submitBtn.textContent = 'กำลังส่งข้อมูล...';
            submitBtn.disabled = true;
            statusMessage.textContent = 'โปรดรอสักครู่...';
            statusMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
            
            const bookingData = {
                timestamp: new Date().toISOString(),
                date: dateInput.value,
                time: selectedTime,
                mainService: mainServiceSelect.value,
                subService: subServiceSelect.value,
                technician: technicianSelect.value,
                price: parseInt(document.getElementById('price').value, 10),
                customerName: customerNameInput.value,
                lineUserId: lineUserIdInput.value,
                phoneNumber: document.getElementById('phoneNumber').value,
                notes: document.getElementById('notes').value,
            };
            
            console.log('Sending booking data:', bookingData);

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData),
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusMessage.textContent = '✅ จองคิวสำเร็จแล้ว! ระบบจะแจ้งเตือนใน LINE ครับ';
                    statusMessage.classList.add('text-green-600');
                    liff.closeWindow();
                } else {
                    statusMessage.textContent = `❌ เกิดข้อผิดพลาด: ${result.message}`;
                    statusMessage.classList.add('text-red-600');
                }
            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = '❌ เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์';
                statusMessage.classList.add('text-red-600');
            } finally {
                submitBtn.textContent = 'ยืนยันการจอง';
                submitBtn.disabled = false;
            }
        });
        
    </script>
</body>
</html>
